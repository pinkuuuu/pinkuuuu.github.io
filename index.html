<!DOCTYPE html> 
<head>
	<title>Video/Canvas Sobel Edge Detection</title> 
	<style> 
		#c {
			position: absolute;
			top: 50%;
			left: 50%;
			margin: -180px 0 0 20px;
		}
		 
		#v {
			position: absolute;
			top: 50%;
			left: 50%;
			margin: -180px 0 0 -500px;
		}
		</style> 
</head>
<body>
	<h2>Tên: Trịnh Phú Hồng</h1>
	<h2>MSSV: 18120389</h2>
	<video id=v controls loop> 
		<source src=video.mp4 type=video/mp4>
	</video> 
	<canvas id=c></canvas> 

	<script> 
		document.addEventListener('DOMContentLoaded', function(){
			var v = document.getElementById('v');
			var canvas = document.getElementById('c');
			var context = canvas.getContext('2d');
			var back = document.createElement('canvas');
			var backcontext = back.getContext('2d');
		 
			var cw,ch;
		 
			v.addEventListener('play', function(){
				cw = v.clientWidth;
				ch = v.clientHeight;
				canvas.width = cw;
				canvas.height = ch;
				back.width = cw;
				back.height = ch;
				draw(v,context,backcontext,cw,ch);
			},false);
		 
		},false);
		


		function draw(v,c,bc,w,h) {
			if(v.paused || v.ended)	return false;
			// First, draw it into the backing canvas
			bc.drawImage(v,0,0,w,h);
			// Grab the pixel data from the backing canvas
			var idata = bc.getImageData(0,0,w,h);
			var data = idata.data;

			const sobel_v = [ -1, 0, 1, -2, 0, 2, -1, 0, 1 ];
			const sobel_h = [ -1, -2, -1, 0, 0, 0, 1, 2, 1 ];

			//Loop through the pixels, turning them grayscale
			for(var i = 0; i < data.length; i+=4) {
				var r = data[i];
				var g = data[i+1];
				var b = data[i+2];
				var brightness = (3*r+4*g+b)>>>3;

				data[i] = brightness;
				data[i+1] = brightness;
				data[i+2] = brightness;
			}

			// idata.data = data;
			// // Draw the pixels onto the visible canvas
			// c.putImageData(idata,0,0);
			
			// idata = bc.getImageData(0,0,w,h);
			// data = idata.data;

			for(var i = 0; i < data.length; i+=4) {
				//Top, Bottom rows ; most Left, most Right cols
				// i <= w*4 && i > w*4*((h-1)*4) && i%(w*4) == 0 && (i+4)%(w*4) == 0
				if(i > w*4 && i <= (w*(h-1))*4 && i%(w*4) != 0 && (i+4)%(w*4) != 0) {
					let h_sum = data[i-(w*4)-4]*sobel_h[0] + data[i-(w*4)]*sobel_h[1] + data[i-(w*4)+4]*sobel_h[2] + data[i-4]*sobel_h[3] + data[i]*sobel_h[4] + data[i+4]*sobel_h[5] + data[i+(w*4)-4]*sobel_h[6] + data[i+(w*4)]*sobel_h[7] + data[i+(w*4)+4]*sobel_h[8];
					let v_sum = data[i-(w*4)-4]*sobel_v[0] + data[i-(w*4)]*sobel_v[1] + data[i-(w*4)+4]*sobel_v[2] + data[i-4]*sobel_v[3] + data[i]*sobel_v[4] + data[i+4]*sobel_v[5] + data[i+(w*4)-4]*sobel_v[6] + data[i+(w*4)]*sobel_v[7] + data[i+(w*4)+4]*sobel_v[8];
					let g = Math.floor(Math.sqrt(h_sum*h_sum + v_sum*v_sum));
					data[i] = g;
					data[i+1] = g;
					data[i+2] = g;
				}
				else{
					data[i] = 255;
					data[i+1] = 0;
					data[i+2] = 0;
				}
			}

			idata.data = data;
			// Draw the pixels onto the visible canvas
			c.putImageData(idata,0,0);
			// Start over!
			setTimeout(draw,20,v,c,bc,w,h);
		}
		</script> 
</body>
